<!DOCTYPE html>
<html>
<head>
	<title>Meyda</title>
	<script type="text/javascript" src="meyda.js"></script>
	<script type="text/javascript" src="lib/jsfft/complex_array.js"></script>
	<script type="text/javascript" src="lib/jsfft/fft.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/0.2.0/Chart.min.js"></script>
	<link rel="stylesheet" type="text/css" href="styles.css">
	<meta charset="UTF-8">
</head>
<body>
	<h3>meyda</h3>
	<h4>audio feature extraction library for the Web</h4>
	<form id="featuresForm">

	</form>
	<div id="extraction">
		<audio src="audio/speech.mp3" id="tune" controls></audio><br><br>
	</div>
	<script>
		var meyda;
		var featuresToExtract = [];
		var extractionInterval;
		var myBarChart = [];
		var data = [];
		var ctx = [];

		var tune = document.getElementById('tune');
		tune.oncanplaythrough = function (e) {
			tune.volume = 1.0;
			console.log("audio loaded");
			init();
		}

		// callback for mic position
		function init() {


			// polyfill
			window.AudioContext = window.AudioContext || window.webkitAudioContext;
			var context = new AudioContext();

			// create audionode from mic
			window.source = context.createMediaElementSource( tune );

			// instantiate new medya
			meyda = new Meyda(context,source,512);

			$.each(meyda.featureExtractors, function(v, i) {
				$("#featuresForm").append('<input class="featureCheckbox" type="checkbox" id="' + v + '" name="' + v + '">' + v + '<br>');
			});

			$("#featuresForm").append('<br><button type="button" id="submitFeatures">Extract Features</button>');


			$("#submitFeatures").click(function(){
				$(".featureCheckbox").each(function(){
					if(this.checked) {
						featuresToExtract.push($(this).attr("id"));
						$("#extraction").append('<h4>' + $(this).attr("id") + ':</h4>' + '<canvas width="400" height="400" id="' + $(this).attr("id") + 'Display"></canvas');
					}
				});

				
				$("#featuresForm").fadeOut(100, function() {
					$("#extraction").fadeIn();
					var f = meyda.get(featuresToExtract);
					$.each(featuresToExtract, function(i, v) {
						// console.log();
						// if (typeof f[v] == "object") {
							// $("#" + v + "Display").empty();
							data[i] = {
							    labels: [v],
							    datasets: [
							        {
							            // label: "My First dataset",
							            fillColor: "rgba(220,220,220,0.5)",
							            strokeColor: "rgba(220,220,220,0.8)",
							            highlightFill: "rgba(220,220,220,0.75)",
							            highlightStroke: "rgba(220,220,220,1)",
							            data: [0]
							        },
							    ]
							};
							
						 	ctx[i] = document.getElementById(v+"Display").getContext("2d");
							myBarChart[i] = new Chart(ctx[i]).Bar(data[i]);
						});
					tune.play();
				});
			});


			
			// $.each(featuresToExtract, function(i, v) {
				// if (typeof f[v] == "object") {
					// $("#testDisplay").empty();
					window.onload = function() { 
						
					}
				// }
			// });

			tune.onplay = function() {
				tune.play();
				// console.log("playing");

				extractionInterval = setInterval(function() {
					var f = meyda.get(featuresToExtract);
					$.each(featuresToExtract, function(i, v) {
						// console.log(f[v]);
						// console.log(myBarChart);
						myBarChart[i].datasets[0].points[0].value = f[v];
						myBarChart[i].update();
						// if (typeof f[v] == "object") {
							// $("#" + v + "Display").empty();
							$.each(f[v], function(ind, val){
								// $("#" + v + "Display").append(f[v][ind] + " ");

							});
							// $("#" + v + "Display").append("<br><br>");
						// }
						// else {
							// $("#" + v + "Display").html(f[v] + "<br><br>");
						// }
					});
				}, 50);
			};

			tune.onpause = function() {
				clearInterval(extractionInterval);
			}

			document.onkeydown = function() {
				tune.play();
			}
		}

	</script>
</body>
</html>